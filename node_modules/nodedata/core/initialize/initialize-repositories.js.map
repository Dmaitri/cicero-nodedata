{"version":3,"sources":["core/initialize/initialize-repositories.ts"],"names":[],"mappings":"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","file":"core/initialize/initialize-repositories.js","sourcesContent":["import {MetaUtils} from \"../metadata/utils\";\nimport * as Utils from \"../utils\";\nimport * as mongooseUtils from '../../mongoose/utils';\nimport {MetaData} from '../metadata/metadata';\nimport {ExportTypes} from '../constants/decorators';\nimport {IDynamicRepository, DynamicRepository} from '../dynamic/dynamic-repository';\nimport {InstanceService} from '../services/instance-service';\nimport {ParamTypeCustom} from '../metadata/param-type-custom';\nimport {searchUtils} from \"../../search/elasticSearchUtils\";\nvar Config = Utils.config();\nimport {Decorators} from '../constants';\nimport {DecoratorType} from '../enums/decorator-type';\n\nimport {IRepositoryParams} from '../decorators/interfaces';\nimport {repositoryMap} from '../exports/repositories';\n\nimport {ISchemaGenerator} from '../interfaces/schema-generator';\nimport * as Enumerable from 'linq';\nimport {repoFromModel} from '../dynamic/model-entity';\n\nexport var mongooseNameSchemaMap: { [key: string]: any } = {};\n\nimport * as securityImpl from '../dynamic/security-impl';\nvar domain = require('domain');\n\nvar Messenger = require('../../mongoose/pubsub/messenger');\nimport {PrincipalContext} from '../../security/auth/principalContext';\nimport {Session} from  '../../models/session';\nimport * as configUtils from '../utils';\n\nexport var repoMap: { [key: string]: { fn: Object, repo: IDynamicRepository } } = <any>{};\n\nexport class InitializeRepositories {\n  \n\n    constructor(server?: any) {\n        this.initializeRepo();\n       \n    }\n\n   \n\n    private initializeRepo() {\n        let self = this;\n        let repositories = MetaUtils.getMetaDataForDecorators([Decorators.REPOSITORY]);\n\n        \n\n\n\n\n        Enumerable.from(repositories)\n            .forEach((x: { target: Object, metadata: Array<MetaData> }) => {\n                if (!x.metadata || !x.metadata.length) {\n                    return;\n                }\n                //let params = <IRepositoryParams>x.metadata[0].params;\n                //let repositoryModel = MetaUtils.getMetaData(params.model.prototype, Decorators.DOCUMENT);\n                //let schemaName = (<IDocumentParams>repositoryModel.params).name; // model name i.e. schema name\n                //let schema = new DynamicSchema(params.model, schemaName);\n                //let mongooseSchema = schema.getSchema();\n                //mongooseSchemaMap[(<any>x.target).path] = { schema: mongooseSchema, name: schema.schemaName, fn: x.target };\n                //mongooseNameSchemaMap[schema.schemaName] = mongooseSchema;\n\n                let path = (<any>x.target).path;\n                let repoParams = <IRepositoryParams>x.metadata[0].params;\n                let model = repoParams.model;\n                let newRepo: DynamicRepository;\n                let rootRepo = new DynamicRepository();\n                rootRepo.initialize(repoParams.path, x.target, model);\n\n                if (x.target instanceof DynamicRepository) {\n                    newRepo = <DynamicRepository>InstanceService.getInstance(x.target, null, null);\n                }\n                else {\n                    newRepo = rootRepo;\n                }\n                newRepo.initialize(repoParams.path, x.target, model, rootRepo);\n\n                repoMap[path] = {\n                    fn: x.target,\n                    repo: newRepo\n                };\n                var metas = MetaUtils.getMetaDataFromDecoratorType(model, DecoratorType.MODEL);\n                if (metas && metas[0] && x.metadata[0]) {\n                    repoFromModel[metas[0].params.name] = newRepo;\n                    newRepo.setMetaData(x.metadata[0]);\n                }\n\n               \n                metas && metas[0] && (repoFromModel[metas[0].params.name] = newRepo);\n\n                \n                //searchMetaUtils.registerToMongoosastic(repoMap[path].repo.getModel());\n            });\n\n        \n\n        repositoryMap(repoMap);\n    }\n}\n"],"sourceRoot":"/source/"}